<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structure Viewer - Protein Competition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdbe-molstar@3.3.0/build/pdbe-molstar.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .header {
            background: #16213e;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0f3460;
        }
        .header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }
        .submission-info {
            font-size: 0.9rem;
            color: #aaa;
        }
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        .viewer-panel {
            flex: 1;
            position: relative;
        }
        #molstar-viewer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .sidebar {
            width: 320px;
            background: #16213e;
            padding: 1.5rem;
            overflow-y: auto;
            border-left: 1px solid #0f3460;
        }
        .sidebar h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #e94560;
        }
        .info-card {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .info-card h3 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.5rem;
        }
        .info-card p {
            font-size: 1rem;
        }
        .plddt-legend {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .plddt-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .plddt-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .download-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            margin-top: 0.5rem;
        }
        .download-btn:hover {
            background: #ff6b6b;
        }
        .download-btn.secondary {
            background: #0f3460;
        }
        .download-btn.secondary:hover {
            background: #1a4a7a;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
        }
        .error {
            color: #e94560;
            padding: 2rem;
            text-align: center;
        }

        /* Problem selector for multi-problem results */
        .problem-selector {
            margin-bottom: 1rem;
        }
        .problem-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .problem-tab {
            padding: 0.5rem 1rem;
            background: #0f0f23;
            border: 2px solid #2a3f5f;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .problem-tab:hover {
            border-color: #65cbf3;
            color: #fff;
        }
        .problem-tab.active {
            background: #e94560;
            border-color: #e94560;
            color: #fff;
        }

        /* Files list */
        .files-list {
            margin-top: 1rem;
        }
        .files-list h3 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.5rem;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #0f0f23;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        .file-item a {
            color: #65cbf3;
            text-decoration: none;
        }
        .file-item a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-left: none;
                border-top: 1px solid #0f3460;
            }
            .viewer-panel {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Protein Structure Viewer</h1>
        <div class="submission-info" id="submission-info">Loading...</div>
    </div>

    <div class="container">
        <div class="viewer-panel">
            <div id="molstar-viewer">
                <div class="loading">Loading structure...</div>
            </div>
        </div>

        <div class="sidebar">
            <div id="problem-selector" class="problem-selector" style="display: none;">
                <h2>Select Problem</h2>
                <div class="problem-tabs" id="problem-tabs"></div>
            </div>

            <h2>Structure Info</h2>

            <div class="info-card">
                <h3>Participant</h3>
                <p id="participant-id">-</p>
            </div>

            <div class="info-card" id="problem-info-card" style="display: none;">
                <h3>Current Problem</h3>
                <p id="current-problem">-</p>
            </div>

            <div class="info-card">
                <h3>pLDDT Color Scale</h3>
                <div class="plddt-legend">
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #0053d6;"></div>
                        <span>Very high (pLDDT > 90)</span>
                    </div>
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #65cbf3;"></div>
                        <span>High (90 > pLDDT > 70)</span>
                    </div>
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #ffdb13;"></div>
                        <span>Low (70 > pLDDT > 50)</span>
                    </div>
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #ff7d45;"></div>
                        <span>Very low (pLDDT < 50)</span>
                    </div>
                </div>
            </div>

            <a id="download-current" class="download-btn" href="#" download>Download Current Structure</a>

            <div class="files-list" id="files-list">
                <h3>All Files</h3>
                <div id="files-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdbe-molstar@3.3.0/build/pdbe-molstar-plugin.js"></script>
    <script>
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Base URL for results
        const RESULTS_BASE_URL = new URL('./results/', window.location.href).href;

        let metadata = null;
        let submission = null;
        let viewerInstance = null;
        let currentProblem = null;

        async function loadResults() {
            if (!token) {
                document.getElementById('molstar-viewer').innerHTML =
                    '<div class="error">No token provided. Please use the link from your submission.</div>';
                return;
            }

            try {
                // Load metadata
                const metadataUrl = `${RESULTS_BASE_URL}${token}/metadata.json`;
                const metadataResponse = await fetch(metadataUrl);

                if (!metadataResponse.ok) {
                    throw new Error('Results not found. The link may have expired or be invalid.');
                }

                metadata = await metadataResponse.json();

                // Load submission info
                const submissionUrl = `${RESULTS_BASE_URL}${token}/submission.json`;
                const submissionResponse = await fetch(submissionUrl);
                submission = await submissionResponse.json();

                // Update header
                document.getElementById('submission-info').textContent =
                    `Submission: ${submission.participant_id || submission.submission_id}`;
                document.getElementById('participant-id').textContent =
                    submission.participant_id || 'Unknown';

                // Check if this is a multi-problem result
                if (metadata.problems && Object.keys(metadata.problems).length > 0) {
                    setupMultiProblemView();
                } else {
                    setupSingleProblemView();
                }

                // Display file list
                displayFileList();

            } catch (error) {
                document.getElementById('molstar-viewer').innerHTML =
                    `<div class="error">${error.message}</div>`;
                console.error('Error loading results:', error);
            }
        }

        let currentSequence = null;

        function setupMultiProblemView() {
            const problems = Object.keys(metadata.problems).sort();

            // Show problem selector
            const selectorDiv = document.getElementById('problem-selector');
            const tabsDiv = document.getElementById('problem-tabs');
            selectorDiv.style.display = 'block';
            document.getElementById('problem-info-card').style.display = 'block';

            // Create tabs for each problem
            tabsDiv.innerHTML = problems.map(problemId => {
                const problemData = metadata.problems[problemId];
                const seqCount = problemData.sequences ? Object.keys(problemData.sequences).length : 1;
                const displayName = problemId.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                const seqBadge = seqCount > 1 ? ` <span style="font-size: 0.7rem; opacity: 0.7;">(${seqCount})</span>` : '';
                return `<button class="problem-tab" data-problem="${problemId}">${displayName}${seqBadge}</button>`;
            }).join('');

            // Add click handlers
            tabsDiv.querySelectorAll('.problem-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const problemId = tab.dataset.problem;
                    selectProblem(problemId);
                });
            });

            // Select first problem by default
            if (problems.length > 0) {
                selectProblem(problems[0]);
            }
        }

        function setupSingleProblemView() {
            // Find the CIF file
            const cifFile = metadata.files.find(f => f.endsWith('.cif'));
            if (!cifFile) {
                throw new Error('No structure file found in results.');
            }

            loadStructure(cifFile);

            // Set download link
            document.getElementById('download-current').href = `${RESULTS_BASE_URL}${token}/${cifFile}`;
        }

        function selectProblem(problemId) {
            currentProblem = problemId;
            currentSequence = null;

            // Update tab states
            document.querySelectorAll('.problem-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.problem === problemId);
            });

            // Update current problem display
            const displayName = problemId.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
            document.getElementById('current-problem').textContent = displayName;

            // Check if this problem has multiple sequences
            const problemData = metadata.problems[problemId];
            const sequences = problemData?.sequences || {};
            const seqNums = Object.keys(sequences).sort((a, b) => parseInt(a) - parseInt(b));

            // Show/hide sequence selector
            let seqSelectorHtml = '';
            if (seqNums.length > 1) {
                seqSelectorHtml = `
                    <div style="margin-top: 0.5rem;">
                        <span style="color: #888; font-size: 0.85rem;">Sequences: </span>
                        ${seqNums.map(seqNum =>
                            `<button class="problem-tab seq-tab" data-seq="${seqNum}" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Seq ${seqNum}</button>`
                        ).join(' ')}
                    </div>
                `;
            }

            // Add sequence selector to current-problem card
            const problemInfoCard = document.getElementById('problem-info-card');
            let seqContainer = problemInfoCard.querySelector('.seq-selector');
            if (!seqContainer) {
                seqContainer = document.createElement('div');
                seqContainer.className = 'seq-selector';
                problemInfoCard.appendChild(seqContainer);
            }
            seqContainer.innerHTML = seqSelectorHtml;

            // Add click handlers for sequence tabs
            seqContainer.querySelectorAll('.seq-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const seqNum = tab.dataset.seq;
                    selectSequence(problemId, seqNum);
                });
            });

            // Select first sequence by default
            if (seqNums.length > 0) {
                selectSequence(problemId, seqNums[0]);
            } else {
                // Fall back to finding file directly (legacy format)
                const problemFiles = problemData?.files || [];
                const cifFile = problemFiles.find(f => f.endsWith('_model.cif')) ||
                               metadata.files.find(f => f.includes(problemId) && f.endsWith('.cif'));

                if (cifFile) {
                    loadStructure(cifFile);
                    document.getElementById('download-current').href = `${RESULTS_BASE_URL}${token}/${cifFile}`;
                } else {
                    document.getElementById('molstar-viewer').innerHTML =
                        `<div class="error">No structure file found for ${displayName}.</div>`;
                }
            }
        }

        function selectSequence(problemId, seqNum) {
            currentSequence = seqNum;

            // Update sequence tab states
            document.querySelectorAll('.seq-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.seq === seqNum);
            });

            // Find the model file for this sequence
            const problemData = metadata.problems[problemId];
            const seqData = problemData?.sequences?.[seqNum];
            const seqFiles = seqData?.files || [];

            // Look for model file
            let cifFile = seqFiles.find(f => f.endsWith('_model.cif'));

            // If not found in sequence data, try problem files with seq suffix
            if (!cifFile) {
                cifFile = problemData?.files?.find(f => f.includes(`_seq${seqNum}_`) && f.endsWith('_model.cif'));
            }

            // Fall back to any model file for this problem
            if (!cifFile) {
                cifFile = metadata.files.find(f => f.includes(problemId) && f.includes(`seq${seqNum}`) && f.endsWith('.cif'));
            }

            if (cifFile) {
                loadStructure(cifFile);
                document.getElementById('download-current').href = `${RESULTS_BASE_URL}${token}/${cifFile}`;
            } else {
                document.getElementById('molstar-viewer').innerHTML =
                    `<div class="error">No structure file found for sequence ${seqNum}.</div>`;
            }
        }

        function loadStructure(cifFile) {
            const viewerContainer = document.getElementById('molstar-viewer');
            viewerContainer.innerHTML = '';

            const cifUrl = `${RESULTS_BASE_URL}${token}/${cifFile}`;

            viewerInstance = new PDBeMolstarPlugin();

            const options = {
                customData: {
                    url: cifUrl,
                    format: 'cif',
                    binary: false
                },
                alphafoldView: true,
                bgColor: { r: 26, g: 26, b: 46 },
                hideControls: false,
                sequencePanel: true,
                landscape: true
            };

            viewerInstance.render(viewerContainer, options);
        }

        function displayFileList() {
            const container = document.getElementById('files-container');

            // Group files by type
            const structures = metadata.files.filter(f => f.endsWith('.cif'));
            const otherFiles = metadata.files.filter(f => !f.endsWith('.cif') && f !== 'submission.json' && f !== 'metadata.json');

            let html = '';

            // Structure files
            structures.forEach(file => {
                const url = `${RESULTS_BASE_URL}${token}/${file}`;
                html += `<div class="file-item"><span>${file}</span><a href="${url}" download>Download</a></div>`;
            });

            // Other files (confidences, etc.)
            otherFiles.forEach(file => {
                const url = `${RESULTS_BASE_URL}${token}/${file}`;
                html += `<div class="file-item"><span>${file}</span><a href="${url}" download>Download</a></div>`;
            });

            container.innerHTML = html || '<p style="color: #888; font-size: 0.85rem;">No additional files.</p>';
        }

        // Load on page ready
        loadResults();
    </script>
</body>
</html>
