<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structure Viewer - Protein Competition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdbe-molstar@3.3.0/build/pdbe-molstar.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .header {
            background: #16213e;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0f3460;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .nav-links {
            display: flex;
            gap: 1rem;
        }
        .nav-links a {
            color: #65cbf3;
            text-decoration: none;
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .nav-links a:hover {
            background: rgba(101, 203, 243, 0.1);
            text-decoration: none;
        }
        .header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }
        .submission-info {
            font-size: 0.9rem;
            color: #aaa;
        }
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        .viewer-panel {
            flex: 1;
            position: relative;
        }
        #molstar-viewer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .sidebar {
            width: 320px;
            background: #16213e;
            padding: 1.5rem;
            overflow-y: auto;
            border-left: 1px solid #0f3460;
        }
        .sidebar h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #e94560;
        }
        .info-card {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .info-card h3 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.5rem;
        }
        .info-card p {
            font-size: 1rem;
        }
        .plddt-legend {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .plddt-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .plddt-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .download-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            margin-top: 0.5rem;
        }
        .download-btn:hover {
            background: #ff6b6b;
        }
        .download-btn.secondary {
            background: #0f3460;
        }
        .download-btn.secondary:hover {
            background: #1a4a7a;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
        }
        .error {
            color: #e94560;
            padding: 2rem;
            text-align: center;
        }

        /* Problem selector for multi-problem results */
        .problem-selector {
            margin-bottom: 1rem;
        }
        .problem-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .problem-tab {
            padding: 0.5rem 1rem;
            background: #0f0f23;
            border: 2px solid #2a3f5f;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .problem-tab:hover {
            border-color: #65cbf3;
            color: #fff;
        }
        .problem-tab.active {
            background: #e94560;
            border-color: #e94560;
            color: #fff;
        }

        /* Files list */
        .files-list {
            margin-top: 1rem;
        }
        .files-list h3 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.5rem;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #0f0f23;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        .file-item a {
            color: #65cbf3;
            text-decoration: none;
        }
        .file-item a:hover {
            text-decoration: underline;
        }

        /* Metrics display */
        .metrics-card {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .metrics-card h3 {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.75rem;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid #2a3f5f;
            font-size: 0.9rem;
        }
        .metric-row:last-child {
            border-bottom: none;
        }
        .metric-name {
            color: #aaa;
        }
        .metric-value {
            font-weight: 600;
            color: #65cbf3;
        }
        .metric-value.primary {
            color: #e94560;
            font-size: 1.1rem;
        }
        .metrics-comparison {
            margin-top: 1rem;
        }
        .metrics-comparison table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .metrics-comparison th, .metrics-comparison td {
            padding: 0.4rem;
            text-align: center;
            border-bottom: 1px solid #2a3f5f;
        }
        .metrics-comparison th {
            color: #aaa;
            font-weight: normal;
        }
        .metrics-comparison tr.best-seq {
            background: rgba(233, 69, 96, 0.15);
        }
        .metrics-comparison tr.best-seq td {
            color: #e94560;
            font-weight: 600;
        }
        .best-badge {
            background: #e94560;
            color: white;
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            margin-left: 0.3rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-left: none;
                border-top: 1px solid #0f3460;
            }
            .viewer-panel {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <nav class="nav-links">
                <a href="./">‚Üê Submit</a>
                <a href="./leaderboard.html">üèÜ Leaderboard</a>
            </nav>
            <h1>Structure Viewer</h1>
        </div>
        <div class="submission-info" id="submission-info">Loading...</div>
    </div>

    <div class="container">
        <div class="viewer-panel">
            <div id="molstar-viewer">
                <div class="loading">Loading structure...</div>
            </div>
        </div>

        <div class="sidebar">
            <div id="problem-selector" class="problem-selector" style="display: none;">
                <h2>Select Problem</h2>
                <div class="problem-tabs" id="problem-tabs"></div>
            </div>

            <h2>Structure Info</h2>

            <div class="info-card">
                <h3>Participant</h3>
                <p id="participant-id">-</p>
            </div>

            <div class="info-card" id="problem-info-card" style="display: none;">
                <h3>Current Problem</h3>
                <p id="current-problem">-</p>
            </div>

            <div class="metrics-card" id="metrics-card" style="display: none;">
                <h3>Evaluation Metrics</h3>
                <div id="metrics-display"></div>
                <div id="metrics-comparison" class="metrics-comparison"></div>
            </div>

            <div class="info-card">
                <h3>pLDDT Color Scale</h3>
                <div class="plddt-legend">
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #0053d6;"></div>
                        <span>Very high (pLDDT > 90)</span>
                    </div>
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #65cbf3;"></div>
                        <span>High (90 > pLDDT > 70)</span>
                    </div>
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #ffdb13;"></div>
                        <span>Low (70 > pLDDT > 50)</span>
                    </div>
                    <div class="plddt-item">
                        <div class="plddt-color" style="background: #ff7d45;"></div>
                        <span>Very low (pLDDT < 50)</span>
                    </div>
                </div>
            </div>

            <a id="download-current" class="download-btn" href="#" download>Download Current Structure</a>

            <div class="files-list" id="files-list">
                <h3>All Files</h3>
                <div id="files-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdbe-molstar@3.3.0/build/pdbe-molstar-plugin.js"></script>
    <script>
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Base URL for results
        const RESULTS_BASE_URL = new URL('./results/', window.location.href).href;

        let metadata = null;
        let submission = null;
        let viewerInstance = null;
        let currentProblem = null;
        let evaluationCache = {};  // Cache for evaluation data

        async function loadResults() {
            if (!token) {
                document.getElementById('molstar-viewer').innerHTML =
                    '<div class="error">No token provided. Please use the link from your submission.</div>';
                return;
            }

            try {
                // Load metadata
                const metadataUrl = `${RESULTS_BASE_URL}${token}/metadata.json`;
                const metadataResponse = await fetch(metadataUrl);

                if (!metadataResponse.ok) {
                    throw new Error('Results not found. The link may have expired or be invalid.');
                }

                metadata = await metadataResponse.json();

                // Load submission info
                const submissionUrl = `${RESULTS_BASE_URL}${token}/submission.json`;
                const submissionResponse = await fetch(submissionUrl);
                submission = await submissionResponse.json();

                // Update header
                document.getElementById('submission-info').textContent =
                    `Submission: ${submission.participant_id || submission.submission_id}`;
                document.getElementById('participant-id').textContent =
                    submission.participant_id || 'Unknown';

                // Check if this is a multi-problem result
                if (metadata.problems && Object.keys(metadata.problems).length > 0) {
                    setupMultiProblemView();
                } else {
                    setupSingleProblemView();
                }

                // Display file list
                displayFileList();

            } catch (error) {
                document.getElementById('molstar-viewer').innerHTML =
                    `<div class="error">${error.message}</div>`;
                console.error('Error loading results:', error);
            }
        }

        let currentSequence = null;

        function setupMultiProblemView() {
            const problems = Object.keys(metadata.problems).sort();

            // Show problem selector
            const selectorDiv = document.getElementById('problem-selector');
            const tabsDiv = document.getElementById('problem-tabs');
            selectorDiv.style.display = 'block';
            document.getElementById('problem-info-card').style.display = 'block';

            // Create tabs for each problem
            tabsDiv.innerHTML = problems.map(problemId => {
                const problemData = metadata.problems[problemId];
                const seqCount = problemData.sequences ? Object.keys(problemData.sequences).length : 1;
                const displayName = problemId.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                const seqBadge = seqCount > 1 ? ` <span style="font-size: 0.7rem; opacity: 0.7;">(${seqCount})</span>` : '';
                return `<button class="problem-tab" data-problem="${problemId}">${displayName}${seqBadge}</button>`;
            }).join('');

            // Add click handlers
            tabsDiv.querySelectorAll('.problem-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const problemId = tab.dataset.problem;
                    selectProblem(problemId);
                });
            });

            // Select first problem by default
            if (problems.length > 0) {
                selectProblem(problems[0]);
            }
        }

        function setupSingleProblemView() {
            // Find the CIF file
            const cifFile = metadata.files.find(f => f.endsWith('.cif'));
            if (!cifFile) {
                throw new Error('No structure file found in results.');
            }

            loadStructure(cifFile);

            // Set download link
            document.getElementById('download-current').href = `${RESULTS_BASE_URL}${token}/${cifFile}`;
        }

        function selectProblem(problemId) {
            currentProblem = problemId;
            currentSequence = null;

            // Update tab states
            document.querySelectorAll('.problem-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.problem === problemId);
            });

            // Update current problem display
            const displayName = problemId.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
            document.getElementById('current-problem').textContent = displayName;

            // Check if this problem has multiple sequences
            const problemData = metadata.problems[problemId];
            const sequences = problemData?.sequences || {};
            const seqNums = Object.keys(sequences).sort((a, b) => parseInt(a) - parseInt(b));

            // Show/hide sequence selector
            let seqSelectorHtml = '';
            if (seqNums.length > 1) {
                seqSelectorHtml = `
                    <div style="margin-top: 0.5rem;">
                        <span style="color: #888; font-size: 0.85rem;">Sequences: </span>
                        ${seqNums.map(seqNum =>
                            `<button class="problem-tab seq-tab" data-seq="${seqNum}" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Seq ${seqNum}</button>`
                        ).join(' ')}
                    </div>
                `;
            }

            // Add sequence selector to current-problem card
            const problemInfoCard = document.getElementById('problem-info-card');
            let seqContainer = problemInfoCard.querySelector('.seq-selector');
            if (!seqContainer) {
                seqContainer = document.createElement('div');
                seqContainer.className = 'seq-selector';
                problemInfoCard.appendChild(seqContainer);
            }
            seqContainer.innerHTML = seqSelectorHtml;

            // Add click handlers for sequence tabs
            seqContainer.querySelectorAll('.seq-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const seqNum = tab.dataset.seq;
                    selectSequence(problemId, seqNum);
                });
            });

            // Select first sequence by default
            if (seqNums.length > 0) {
                selectSequence(problemId, seqNums[0]);
            } else {
                // Fall back to finding file directly (legacy format)
                const problemFiles = problemData?.files || [];
                const cifFile = problemFiles.find(f => f.endsWith('_model.cif')) ||
                               metadata.files.find(f => f.includes(problemId) && f.endsWith('.cif'));

                if (cifFile) {
                    loadStructure(cifFile);
                    document.getElementById('download-current').href = `${RESULTS_BASE_URL}${token}/${cifFile}`;
                } else {
                    document.getElementById('molstar-viewer').innerHTML =
                        `<div class="error">No structure file found for ${displayName}.</div>`;
                }
            }
        }

        async function selectSequence(problemId, seqNum) {
            currentSequence = seqNum;

            // Update sequence tab states
            document.querySelectorAll('.seq-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.seq === seqNum);
            });

            // Find the model file for this sequence
            const problemData = metadata.problems[problemId];
            const seqData = problemData?.sequences?.[seqNum];
            const seqFiles = seqData?.files || [];

            // Look for model file
            let cifFile = seqFiles.find(f => f.endsWith('_model.cif'));

            // If not found in sequence data, try problem files with seq suffix
            if (!cifFile) {
                cifFile = problemData?.files?.find(f => f.includes(`_seq${seqNum}_`) && f.endsWith('_model.cif'));
            }

            // Fall back to any model file for this problem
            if (!cifFile) {
                cifFile = metadata.files.find(f => f.includes(problemId) && f.includes(`seq${seqNum}`) && f.endsWith('.cif'));
            }

            if (cifFile) {
                loadStructure(cifFile);
                document.getElementById('download-current').href = `${RESULTS_BASE_URL}${token}/${cifFile}`;
            } else {
                document.getElementById('molstar-viewer').innerHTML =
                    `<div class="error">No structure file found for sequence ${seqNum}.</div>`;
            }

            // Load and display evaluation metrics
            const evaluations = await loadAllEvaluations(problemId);
            const bestSeq = findBestSequence(evaluations);
            const currentEval = evaluations[seqNum];
            displayMetrics(currentEval, seqNum === bestSeq);
            displayMetricsComparison(evaluations, seqNum);
        }

        function loadStructure(cifFile) {
            const viewerContainer = document.getElementById('molstar-viewer');
            viewerContainer.innerHTML = '';

            const cifUrl = `${RESULTS_BASE_URL}${token}/${cifFile}`;

            viewerInstance = new PDBeMolstarPlugin();

            const options = {
                customData: {
                    url: cifUrl,
                    format: 'cif',
                    binary: false
                },
                alphafoldView: true,
                bgColor: { r: 26, g: 26, b: 46 },
                hideControls: false,
                sequencePanel: true,
                landscape: true
            };

            viewerInstance.render(viewerContainer, options);
        }

        async function loadEvaluation(problemId, seqNum) {
            const cacheKey = `${problemId}_seq${seqNum}`;
            if (evaluationCache[cacheKey]) {
                return evaluationCache[cacheKey];
            }

            // Try to find evaluation file
            const participantId = submission.participant_id || 'unknown';
            const patterns = [
                `${participantId}_${problemId}_seq${seqNum}_evaluation.json`,
                `${participantId}_${problemId}seq${seqNum}_evaluation.json`,
                `evaluation_${problemId}_seq${seqNum}.json`,
                // Legacy format without seq number (for single-sequence submissions before fix)
                `${participantId}_${problemId}_evaluation.json`,
            ];

            for (const pattern of patterns) {
                try {
                    const url = `${RESULTS_BASE_URL}${token}/${pattern}`;
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        evaluationCache[cacheKey] = data;
                        return data;
                    }
                } catch (e) {
                    // Continue to next pattern
                }
            }
            return null;
        }

        async function loadAllEvaluations(problemId) {
            const problemData = metadata.problems[problemId];
            const sequences = problemData?.sequences || {};
            const seqNums = Object.keys(sequences).sort((a, b) => parseInt(a) - parseInt(b));

            const evaluations = {};
            for (const seqNum of seqNums) {
                const evalData = await loadEvaluation(problemId, seqNum);
                if (evalData) {
                    evaluations[seqNum] = evalData;
                }
            }
            return evaluations;
        }

        function findBestSequence(evaluations, primaryMetric = 'bb_lddt') {
            let bestSeq = null;
            let bestScore = -Infinity;

            for (const [seqNum, evalData] of Object.entries(evaluations)) {
                const score = evalData.primary_score || evalData.metrics?.[primaryMetric] || 0;
                if (score > bestScore) {
                    bestScore = score;
                    bestSeq = seqNum;
                }
            }
            return bestSeq;
        }

        function displayMetrics(evalData, isBest = false) {
            const metricsCard = document.getElementById('metrics-card');
            const metricsDisplay = document.getElementById('metrics-display');

            if (!evalData) {
                metricsCard.style.display = 'none';
                return;
            }

            metricsCard.style.display = 'block';
            const metrics = evalData.metrics || {};
            const af3Metrics = evalData.af3_metrics || {};
            const primaryMetric = evalData.primary_metric || 'bb_lddt';
            const primaryScore = evalData.primary_score;

            let html = '';

            // Primary metric first
            if (primaryScore !== null && primaryScore !== undefined) {
                const bestLabel = isBest ? '<span class="best-badge">BEST</span>' : '';
                html += `<div class="metric-row">
                    <span class="metric-name">${primaryMetric}${bestLabel}</span>
                    <span class="metric-value primary">${primaryScore.toFixed(4)}</span>
                </div>`;
            }

            // Check if this is a binder problem (has binder_metrics)
            const binderMetrics = evalData.binder_metrics || {};
            const isBinder = Object.keys(binderMetrics).length > 0 || evalData.problem_type === 'binder';

            if (isBinder) {
                // Binder-specific metrics (skip if already shown as primary)
                if (binderMetrics.binder_tm_score != null && primaryMetric !== 'tm_score') {
                    html += `<div class="metric-row">
                        <span class="metric-name">Binder TM-score</span>
                        <span class="metric-value">${binderMetrics.binder_tm_score.toFixed(4)}</span>
                    </div>`;
                }
                if (binderMetrics.binder_rmsd != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">Binder RMSD (√Ö)</span>
                        <span class="metric-value">${binderMetrics.binder_rmsd.toFixed(2)}</span>
                    </div>`;
                }
                if (binderMetrics.binder_lddt != null && primaryMetric !== 'bb_lddt') {
                    html += `<div class="metric-row">
                        <span class="metric-name">Binder lDDT</span>
                        <span class="metric-value">${binderMetrics.binder_lddt.toFixed(4)}</span>
                    </div>`;
                }
                // Complex metrics
                if (metrics.complex_tm_score != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">Complex TM-score</span>
                        <span class="metric-value">${metrics.complex_tm_score.toFixed(4)}</span>
                    </div>`;
                }
                if (metrics.complex_rmsd != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">Complex RMSD (√Ö)</span>
                        <span class="metric-value">${metrics.complex_rmsd.toFixed(2)}</span>
                    </div>`;
                }
            } else {
                // Monomer metrics (skip if already shown as primary)
                if (metrics.tm_score != null && primaryMetric !== 'tm_score') {
                    html += `<div class="metric-row">
                        <span class="metric-name">TM-score</span>
                        <span class="metric-value">${metrics.tm_score.toFixed(4)}</span>
                    </div>`;
                }
                if (metrics.bb_lddt != null && primaryMetric !== 'bb_lddt') {
                    html += `<div class="metric-row">
                        <span class="metric-name">BB-lDDT</span>
                        <span class="metric-value">${metrics.bb_lddt.toFixed(4)}</span>
                    </div>`;
                }
                if (metrics.bb_lddt_cov != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">lDDT √ó Coverage</span>
                        <span class="metric-value">${metrics.bb_lddt_cov.toFixed(4)}</span>
                    </div>`;
                }
                if (metrics.rmsd != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">RMSD (aligned) (√Ö)</span>
                        <span class="metric-value">${metrics.rmsd.toFixed(2)}</span>
                    </div>`;
                }
                if (metrics.global_rmsd != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">RMSD (all residues) (√Ö)</span>
                        <span class="metric-value">${metrics.global_rmsd.toFixed(2)}</span>
                    </div>`;
                }
                if (metrics.coverage != null) {
                    html += `<div class="metric-row">
                        <span class="metric-name">Coverage</span>
                        <span class="metric-value">${(metrics.coverage * 100).toFixed(1)}%</span>
                    </div>`;
                }
            }

            // AF3 metrics
            if (af3Metrics.ptm != null) {
                html += `<div class="metric-row">
                    <span class="metric-name">pTM</span>
                    <span class="metric-value">${af3Metrics.ptm.toFixed(2)}</span>
                </div>`;
            }
            if (af3Metrics.iptm != null) {
                html += `<div class="metric-row">
                    <span class="metric-name">ipTM</span>
                    <span class="metric-value">${af3Metrics.iptm.toFixed(2)}</span>
                </div>`;
            }
            if (af3Metrics.ranking_score != null) {
                html += `<div class="metric-row">
                    <span class="metric-name">Ranking Score</span>
                    <span class="metric-value">${af3Metrics.ranking_score.toFixed(2)}</span>
                </div>`;
            }

            metricsDisplay.innerHTML = html;
        }

        function displayMetricsComparison(evaluations, currentSeqNum) {
            const compDiv = document.getElementById('metrics-comparison');
            const seqNums = Object.keys(evaluations).sort((a, b) => parseInt(a) - parseInt(b));

            if (seqNums.length <= 1) {
                compDiv.innerHTML = '';
                return;
            }

            const bestSeq = findBestSequence(evaluations);

            // Check if this is a binder problem
            const firstEval = evaluations[seqNums[0]];
            const isBinder = firstEval?.binder_metrics && Object.keys(firstEval.binder_metrics).length > 0;

            let html = '<h4 style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.5rem;">All Sequences</h4>';

            if (isBinder) {
                html += '<table><thead><tr><th>Seq</th><th>ipTM</th><th>Binder TM</th><th>Binder RMSD</th></tr></thead><tbody>';
            } else {
                html += '<table><thead><tr><th>Seq</th><th>bb_lddt</th><th>TM</th><th>RMSD</th></tr></thead><tbody>';
            }

            for (const seqNum of seqNums) {
                const evalData = evaluations[seqNum];
                const metrics = evalData?.metrics || {};
                const binderMetrics = evalData?.binder_metrics || {};
                const af3Metrics = evalData?.af3_metrics || {};
                const isBest = seqNum === bestSeq;
                const isCurrent = seqNum === currentSeqNum;
                const rowClass = isBest ? 'best-seq' : '';
                const currentMark = isCurrent ? ' ‚óÄ' : '';
                const bestMark = isBest ? ' ‚òÖ' : '';

                if (isBinder) {
                    html += `<tr class="${rowClass}">
                        <td>${seqNum}${bestMark}${currentMark}</td>
                        <td>${af3Metrics.iptm?.toFixed(3) || '-'}</td>
                        <td>${binderMetrics.binder_tm_score?.toFixed(3) || '-'}</td>
                        <td>${binderMetrics.binder_rmsd?.toFixed(2) || '-'}</td>
                    </tr>`;
                } else {
                    html += `<tr class="${rowClass}">
                        <td>${seqNum}${bestMark}${currentMark}</td>
                        <td>${metrics.bb_lddt?.toFixed(4) || '-'}</td>
                        <td>${metrics.tm_score?.toFixed(3) || '-'}</td>
                        <td>${metrics.rmsd?.toFixed(2) || '-'}</td>
                    </tr>`;
                }
            }

            html += '</tbody></table>';
            html += '<p style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">‚òÖ = best, ‚óÄ = current</p>';

            compDiv.innerHTML = html;
        }

        function displayFileList() {
            const container = document.getElementById('files-container');

            // Group files by type
            const structures = metadata.files.filter(f => f.endsWith('.cif'));
            const otherFiles = metadata.files.filter(f => !f.endsWith('.cif') && f !== 'submission.json' && f !== 'metadata.json');

            let html = '';

            // Structure files
            structures.forEach(file => {
                const url = `${RESULTS_BASE_URL}${token}/${file}`;
                html += `<div class="file-item"><span>${file}</span><a href="${url}" download>Download</a></div>`;
            });

            // Other files (confidences, etc.)
            otherFiles.forEach(file => {
                const url = `${RESULTS_BASE_URL}${token}/${file}`;
                html += `<div class="file-item"><span>${file}</span><a href="${url}" download>Download</a></div>`;
            });

            container.innerHTML = html || '<p style="color: #888; font-size: 0.85rem;">No additional files.</p>';
        }

        // Load on page ready
        loadResults();
    </script>
</body>
</html>
