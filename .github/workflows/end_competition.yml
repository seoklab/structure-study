name: End Competition

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "END" to confirm ending the competition'
        required: true
        type: string

jobs:
  end-competition:
    if: github.event.inputs.confirm == 'END'
    runs-on: [self-hosted, galaxy4]

    permissions:
      contents: write
      pages: write
      issues: write

    env:
      SUBMISSIONS_BASE: /home/j2ho/seoklab/structure-study/submissions
      PUBLIC_RESULTS: /home/j2ho/seoklab/structure-study/public_results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Publish all results
        run: |
          python3 scripts/end_competition.py \
            --results-dir "${SUBMISSIONS_BASE}" \
            --public-results-dir "${PUBLIC_RESULTS}" \
            --public-dir docs \
            --results-url results

      - name: Update all issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
        run: |
          gh issue list --label submission --state all --json number --jq '.[].number' | while read ISSUE_NUM; do
            gh issue comment "$ISSUE_NUM" --body "## Competition Ended - All results are now public. View at: ${PAGES_URL}"
            gh issue edit "$ISSUE_NUM" --add-label "competition-ended"
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git commit -m "End competition - publish all results"
          git push

      - name: Summary
        run: |
          echo "## Competition Ended" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All results have been published to GitHub Pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
