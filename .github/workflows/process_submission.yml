name: Process Sequence Submission

on:
  repository_dispatch:
    types: [new_submission]

jobs:
  process-submission:
    runs-on: [self-hosted, galaxy4]

    permissions:
      contents: read

    env:
      SUBMISSIONS_BASE: /data/galaxy4/user/j2ho/kidds2026/protein-competition/submissions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract submission data
        id: extract
        run: |
          # Extract data from repository_dispatch payload
          SUBMISSION_ID="${{ github.event.client_payload.submission_id }}"
          PARTICIPANT_ID="${{ github.event.client_payload.participant_id }}"
          EMAIL="${{ github.event.client_payload.email }}"
          SUBMITTED_AT="${{ github.event.client_payload.submitted_at }}"

          echo "Processing submission: $SUBMISSION_ID from $PARTICIPANT_ID"

          # Create submission directory with group write permissions
          SUBMISSION_DIR="${SUBMISSIONS_BASE}/${SUBMISSION_ID}"
          mkdir -p "${SUBMISSION_DIR}"
          chmod 775 "${SUBMISSION_DIR}"

          echo "SUBMISSION_ID=${SUBMISSION_ID}" >> $GITHUB_ENV
          echo "SUBMISSION_DIR=${SUBMISSION_DIR}" >> $GITHUB_ENV
          echo "PARTICIPANT_ID=${PARTICIPANT_ID}" >> $GITHUB_ENV
          echo "EMAIL=${EMAIL}" >> $GITHUB_ENV

      - name: Save submission data and prepare jobs
        id: prepare
        run: |
          # Save the full submission data as JSON
          cat > "$SUBMISSION_DIR/submission.json" << 'SUBMISSION_EOF'
          ${{ toJson(github.event.client_payload) }}
          SUBMISSION_EOF

          # Process each problem/sequence
          python3 scripts/process_multi_submission.py \
            --submission-dir "$SUBMISSION_DIR" \
            --submission-id "$SUBMISSION_ID"

      - name: Queue AF3 jobs for all problems
        id: queue
        run: |
          QUEUE_DIR="/data/galaxy4/user/j2ho/job_queue"

          # Find all problem directories and queue their jobs
          QUEUED_COUNT=0
          for problem_dir in "$SUBMISSION_DIR"/problem_*; do
            [ ! -d "$problem_dir" ] && continue
            PROBLEM_ID=$(basename "$problem_dir")

            # Generate the SLURM script
            python3 scripts/run_af3.py \
              --submission-dir "$problem_dir" \
              --submission-id "${SUBMISSION_ID}_${PROBLEM_ID}" \
              --mode full

            # Copy to queue directory
            SCRIPT_FILE="$problem_dir/scripts/run_${SUBMISSION_ID}_${PROBLEM_ID}_full.sh"
            if [ -f "$SCRIPT_FILE" ]; then
              cp "$SCRIPT_FILE" "$QUEUE_DIR/${SUBMISSION_ID}_${PROBLEM_ID}.sh"
              chmod 755 "$QUEUE_DIR/${SUBMISSION_ID}_${PROBLEM_ID}.sh"
              QUEUED_COUNT=$((QUEUED_COUNT + 1))
              echo "Queued job for $PROBLEM_ID"
            fi
          done

          echo "Queued $QUEUED_COUNT jobs for submission $SUBMISSION_ID"

          # Update status file
          cat > "$SUBMISSION_DIR/status.json" << EOF
          {
            "status": "queued",
            "submission_id": "$SUBMISSION_ID",
            "participant_id": "$PARTICIPANT_ID",
            "submitted_at": "${{ github.event.client_payload.submitted_at }}",
            "queued_at": "$(date -Iseconds)",
            "problem_count": $QUEUED_COUNT
          }
          EOF

      - name: Send confirmation email
        if: success()
        run: |
          PROBLEM_COUNT=$(python3 -c "import json; print(len(json.load(open('$SUBMISSION_DIR/submission.json')).get('sequences', {})))" 2>/dev/null || echo "0")

          if [ -n "$EMAIL" ]; then
            printf "To: %s\nFrom: noreply@seoklab.org\nSubject: Submission Received - KIDDS 2026\n\nHello,\n\nYour submission has been received and queued for AlphaFold3 structure prediction.\n\nSubmission ID: %s\nParticipant: %s\nProblems submitted: %s\n\nYou will receive another email when your results are ready.\n\nBest regards,\nKIDDS 2026 Winter Workshop\n" "$EMAIL" "$SUBMISSION_ID" "$PARTICIPANT_ID" "$PROBLEM_COUNT" | sendmail -t
            echo "Confirmation email sent to $EMAIL"
          fi

      - name: Log failure
        if: failure()
        run: |
          echo "Failed to process submission $SUBMISSION_ID"
          # Save error status
          cat > "$SUBMISSION_DIR/status.json" << EOF
          {
            "status": "failed",
            "submission_id": "$SUBMISSION_ID",
            "error": "Processing failed",
            "failed_at": "$(date -Iseconds)"
          }
          EOF
