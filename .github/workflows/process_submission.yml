name: Process Sequence Submission

on:
  issues:
    types: [opened]

jobs:
  process-submission:
    if: contains(github.event.issue.labels.*.name, 'submission')
    runs-on: [self-hosted, galaxy4]

    permissions:
      contents: read
      issues: write

    env:
      SUBMISSIONS_BASE: /home/j2ho/seoklab/structure-study/submissions
      SITE_URL: https://seoklab.github.io/structure-study

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse and validate submission
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python3 scripts/parse_issue_submission.py \
            --issue-body "$ISSUE_BODY" \
            --issue-number ${{ github.event.issue.number }} \
            --config docs/targets/config.json \
            --submissions-base "$SUBMISSIONS_BASE"

      - name: Process submission and prepare AF3 jobs
        id: prepare
        run: |
          python3 scripts/process_multi_submission.py \
            --submission-dir "$SUBMISSION_DIR" \
            --submission-id "$SUBMISSION_ID"

      - name: Queue AF3 jobs for all problems
        id: queue
        run: |
          QUEUE_DIR="/data/galaxy4/user/j2ho/job_queue"

          QUEUED_COUNT=0
          for problem_dir in "$SUBMISSION_DIR"/problem_*; do
            [ ! -d "$problem_dir" ] && continue
            PROBLEM_ID=$(basename "$problem_dir")

            for seq_dir in "$problem_dir"/seq_*; do
              [ ! -d "$seq_dir" ] && continue
              SEQ_NUM=$(basename "$seq_dir" | sed 's/seq_//')

              if [ ! -f "$seq_dir/af3_input.json" ]; then
                echo "Skipping $seq_dir - no af3_input.json found"
                continue
              fi

              JOB_ID="${SUBMISSION_ID}_${PROBLEM_ID}_seq${SEQ_NUM}"

              python3 scripts/run_af3.py \
                --submission-dir "$seq_dir" \
                --submission-id "$JOB_ID" \
                --participant-id "$PARTICIPANT_ID" \
                --mode full

              SCRIPT_FILE="$seq_dir/scripts/run_${JOB_ID}_full.sh"
              if [ -f "$SCRIPT_FILE" ]; then
                cp "$SCRIPT_FILE" "$QUEUE_DIR/${JOB_ID}.sh"
                chmod 755 "$QUEUE_DIR/${JOB_ID}.sh"
                QUEUED_COUNT=$((QUEUED_COUNT + 1))
                echo "Queued job for $PROBLEM_ID seq $SEQ_NUM"
              fi
            done
          done

          echo "Queued $QUEUED_COUNT jobs for submission $SUBMISSION_ID"

          cat > "$SUBMISSION_DIR/status.json" << EOF
          {
            "status": "queued",
            "submission_id": "$SUBMISSION_ID",
            "participant_id": "$PARTICIPANT_ID",
            "issue_number": ${{ github.event.issue.number }},
            "submitted_at": "$(python3 -c "import json; print(json.load(open('$SUBMISSION_DIR/submission.json')).get('submitted_at', ''))" 2>/dev/null)",
            "queued_at": "$(date -Iseconds)",
            "job_count": $QUEUED_COUNT
          }
          EOF

      - name: Comment confirmation on issue
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROBLEM_COUNT=$(python3 -c "import json; print(len(json.load(open('$SUBMISSION_DIR/submission.json')).get('sequences', {})))" 2>/dev/null || echo "0")
          PROBLEM_LIST=$(python3 -c "import json; d=json.load(open('$SUBMISSION_DIR/submission.json')); print(', '.join(d.get('sequences', {}).keys()))" 2>/dev/null || echo "")
          SEQ_COUNT=$(python3 -c "import json; d=json.load(open('$SUBMISSION_DIR/submission.json')); print(sum(len(v) for v in d.get('sequences', {}).values()))" 2>/dev/null || echo "0")

          BODY="## Submission Received

          Your sequences have been received and queued for AlphaFold3 structure prediction.

          | Field | Value |
          |-------|-------|
          | **Submission ID** | \`${SUBMISSION_ID}\` |
          | **Participant** | \`${PARTICIPANT_ID}\` |
          | **Problems** | ${PROBLEM_COUNT} (${PROBLEM_LIST}) |
          | **Total sequences** | ${SEQ_COUNT} |

          You will receive another comment when your results are ready."

          gh issue comment ${{ github.event.issue.number }} --body "$BODY"

      - name: Comment failure on issue
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## Submission Failed

          There was an error processing your submission. The organizers have been notified.

          Please check your submission format and try again, or contact the organizers."
          gh issue edit ${{ github.event.issue.number }} --add-label "error"

          # Save error status if submission dir exists
          if [ -n "$SUBMISSION_DIR" ] && [ -d "$SUBMISSION_DIR" ]; then
            cat > "$SUBMISSION_DIR/status.json" << EOF
            {
              "status": "failed",
              "submission_id": "${SUBMISSION_ID:-unknown}",
              "error": "Processing failed",
              "failed_at": "$(date -Iseconds)"
            }
          EOF
          fi
