name: Process Sequence Submission

on:
  issues:
    types: [labeled]

jobs:
  validate-and-run:
    if: github.event.label.name == 'submission'
    runs-on: [self-hosted, af3-runner]

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create submission directory
        run: |
          SUBMISSION_ID="submission_${{ github.event.issue.number }}"
          mkdir -p results/${SUBMISSION_ID}
          echo "SUBMISSION_ID=${SUBMISSION_ID}" >> $GITHUB_ENV
          echo "SUBMISSION_DIR=results/${SUBMISSION_ID}" >> $GITHUB_ENV

      - name: Parse submission from issue
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python3 scripts/parse_submission.py \
            --issue-body "$ISSUE_BODY" \
            --issue-number "$ISSUE_NUMBER" \
            --output-dir "$SUBMISSION_DIR"

      - name: Prepare AF3 input
        id: prepare
        run: |
          python3 scripts/prepare_af3_input.py \
            --submission-dir "$SUBMISSION_DIR" \
            --submission-id "$SUBMISSION_ID"

      - name: Submit AF3 job to SLURM
        id: submit
        run: |
          python3 scripts/run_af3.py \
            --submission-dir "$SUBMISSION_DIR" \
            --submission-id "$SUBMISSION_ID" \
            --mode full \
            --submit 2>&1 | tee submit_output.txt

          # Extract job ID from sbatch output
          JOB_ID=$(grep -oP 'Submitted batch job \K\d+' submit_output.txt || echo "unknown")
          echo "SLURM_JOB_ID=${JOB_ID}" >> $GITHUB_ENV

          # Save status file for tracking
          cat > "$SUBMISSION_DIR/status.json" << EOF
          {
            "status": "processing",
            "slurm_job_id": "${JOB_ID}",
            "issue_number": ${{ github.event.issue.number }},
            "submitted_at": "$(date -Iseconds)"
          }
          EOF

      - name: Comment on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Submission Received\n\nYour sequence has been validated and submitted to AlphaFold3.\n\n**Submission ID:** \`${{ env.SUBMISSION_ID }}\`\n**SLURM Job ID:** \`${{ env.SLURM_JOB_ID }}\`\n\nYou will receive your results privately once processing is complete.`
            })
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['processing']
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Submission Error\n\nThere was an error processing your submission. Please check:\n- Your sequence contains only valid amino acid letters (A, C, D, E, F, G, H, I, K, L, M, N, P, Q, R, S, T, V, W, Y)\n- All required fields are filled out\n\nPlease create a new submission with corrected information.`
            })
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['invalid']
            })
