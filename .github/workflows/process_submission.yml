name: Process Sequence Submission

on:
  issues:
    types: [labeled]

jobs:
  validate-and-run:
    if: github.event.label.name == 'submission'
    runs-on: [self-hosted, galaxy4]

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create submission directory
        run: |
          SUBMISSION_ID="submission_${{ github.event.issue.number }}"
          SUBMISSION_DIR="/data/galaxy4/user/j2ho/kidds2026/protein-competition/submissions/${SUBMISSION_ID}"
          mkdir -p "${SUBMISSION_DIR}"
          mkdir -p "${SUBMISSION_DIR}/scripts"
          mkdir -p "${SUBMISSION_DIR}/logs"
          chmod 777 "${SUBMISSION_DIR}" "${SUBMISSION_DIR}/scripts" "${SUBMISSION_DIR}/logs"
          echo "SUBMISSION_ID=${SUBMISSION_ID}" >> $GITHUB_ENV
          echo "SUBMISSION_DIR=${SUBMISSION_DIR}" >> $GITHUB_ENV

      - name: Parse submission from issue
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python3 scripts/parse_submission.py \
            --issue-body "$ISSUE_BODY" \
            --issue-number "$ISSUE_NUMBER" \
            --output-dir "$SUBMISSION_DIR"

      - name: Prepare AF3 input
        id: prepare
        run: |
          python3 scripts/prepare_af3_input.py \
            --submission-dir "$SUBMISSION_DIR" \
            --submission-id "$SUBMISSION_ID"

      - name: Queue AF3 job for submission
        id: queue
        run: |
          # Generate sbatch script (without submitting)
          python3 scripts/run_af3.py \
            --submission-dir "$SUBMISSION_DIR" \
            --submission-id "$SUBMISSION_ID" \
            --mode full

          # Copy script to j2ho's queue directory for submission under their account
          QUEUE_DIR="/data/galaxy4/user/j2ho/job_queue"
          SCRIPT_FILE="$SUBMISSION_DIR/scripts/run_${SUBMISSION_ID}_full.sh"
          cp "$SCRIPT_FILE" "$QUEUE_DIR/${SUBMISSION_ID}.sh"
          chmod 755 "$QUEUE_DIR/${SUBMISSION_ID}.sh"

          echo "JOB_QUEUED=true" >> $GITHUB_ENV

          # Save status file for tracking
          echo '{"status": "queued", "issue_number": ${{ github.event.issue.number }}, "submitted_at": "'$(date -Iseconds)'"}' > "$SUBMISSION_DIR/status.json"

      - name: Send confirmation email
        if: success()
        run: |
          EMAIL=$(python3 -c "import json; print(json.load(open('$SUBMISSION_DIR/submission.json')).get('email', ''))" 2>/dev/null)
          SEQ_NAME=$(python3 -c "import json; print(json.load(open('$SUBMISSION_DIR/submission.json')).get('sequence_name', ''))" 2>/dev/null)
          if [ -n "$EMAIL" ]; then
            printf "To: %s\nFrom: noreply@seoklab.org\nSubject: Submission Received - KIDDS 2026\n\nHello,\n\nYour sequence \"%s\" has been received and queued for AlphaFold3 structure prediction.\n\nSubmission ID: %s\n\nYou will receive another email when your results are ready.\n\nBest regards,\nKIDDS 2026 Winter Workshop\n" "$EMAIL" "$SEQ_NAME" "$SUBMISSION_ID" | sendmail -t
            echo "Confirmation email sent to $EMAIL"
          fi

      - name: Comment on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Submission Received\n\nYour sequence has been validated and queued for AlphaFold3 processing.\n\n**Submission ID:** \`${{ env.SUBMISSION_ID }}\`\n\nYou will receive your results via email once processing is complete.`
            })
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['processing']
            })

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Submission Error\n\nThere was an error processing your submission. Please check:\n- Your sequence contains only valid amino acid letters (A, C, D, E, F, G, H, I, K, L, M, N, P, Q, R, S, T, V, W, Y)\n- All required fields are filled out\n\nPlease create a new submission with corrected information.`
            })
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['invalid']
            })

