name: Check Job Completion

on:
  # Runs every minute when enabled
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  check-jobs:
    runs-on: [self-hosted, galaxy4]
    permissions:
      contents: write
    env:
      SUBMISSIONS_BASE: /data/galaxy4/user/j2ho/kidds2026/protein-competition/submissions
      PUBLIC_RESULTS: /data/galaxy4/user/j2ho/kidds2026/protein-competition/public_results
      SITE_URL: https://kidds2026.netlify.app
      ADMIN_EMAIL: jihosim1010@gmail.com
      # Set to "true" for email after each problem (uses more Netlify deploys)
      # Set to "false" for single email when all problems complete (default)
      INCREMENTAL_NOTIFICATIONS: "false"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check and package completed submissions
        id: check
        run: |
          RESULTS_UPDATED=false

          # Process all submissions (directories with status.json)
          for dir in ${SUBMISSIONS_BASE}/*/; do
            [ ! -d "$dir" ] && continue

            STATUS_FILE="${dir}status.json"
            [ ! -f "$STATUS_FILE" ] && continue

            # Read status
            STATUS=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('status', 'unknown'))" 2>/dev/null || echo "unknown")

            # Skip if already completed or notified_partial or notified_failed
            [ "$STATUS" = "completed" ] || [ "$STATUS" = "notified_partial" ] || [ "$STATUS" = "notified_failed" ] && continue

            SUBMISSION_ID=$(basename "$dir")
            echo "Checking $SUBMISSION_ID (status: $STATUS)..."

            # Get submission info
            SUBMISSION_FILE="$dir/submission.json"
            EMAIL=$(python3 -c "import json; print(json.load(open('$SUBMISSION_FILE')).get('email', ''))" 2>/dev/null || echo "")
            PARTICIPANT_ID=$(python3 -c "import json; print(json.load(open('$SUBMISSION_FILE')).get('participant_id', 'unknown'))" 2>/dev/null || echo "unknown")

            # Check for multi-problem submission
            PROBLEM_DIRS=$(find "$dir" -maxdepth 1 -type d -name "problem_*" 2>/dev/null | sort)
            PROBLEM_COUNT=$(echo "$PROBLEM_DIRS" | grep -c "problem_" || echo "0")

            if [ "$PROBLEM_COUNT" -gt 0 ]; then
              # Multi-problem submission
              TOTAL_PROBLEMS=$(python3 -c "import json; d=json.load(open('$SUBMISSION_FILE')); print(len(d.get('sequences', {})))" 2>/dev/null || echo "$PROBLEM_COUNT")

              # Get already notified problems from status
              NOTIFIED_PROBLEMS=$(python3 -c "import json; print(','.join(json.load(open('$STATUS_FILE')).get('notified_problems', [])))" 2>/dev/null || echo "")

              COMPLETED_LIST=""
              FAILED_LIST=""
              PENDING_LIST=""
              NEW_COMPLETED_LIST=""
              COMPLETED_COUNT=0
              FAILED_COUNT=0

              for problem_dir in $PROBLEM_DIRS; do
                [ ! -d "$problem_dir" ] && continue
                PROBLEM_ID=$(basename "$problem_dir")

                # Check for model.cif (success)
                if find "$problem_dir" -maxdepth 2 -name "*_model.cif" -type f 2>/dev/null | head -1 | grep -q .; then
                  COMPLETED_COUNT=$((COMPLETED_COUNT + 1))
                  COMPLETED_LIST="${COMPLETED_LIST}${PROBLEM_ID}, "
                  # Check if this is newly completed (not yet notified)
                  if ! echo ",$NOTIFIED_PROBLEMS," | grep -q ",${PROBLEM_ID},"; then
                    NEW_COMPLETED_LIST="${NEW_COMPLETED_LIST}${PROBLEM_ID}, "
                  fi
                else
                  # Check SLURM job status for this problem
                  JOB_NAME="${SUBMISSION_ID}_${PROBLEM_ID}"
                  # Check if job failed (look for FAILED status in sacct)
                  JOB_STATUS=$(sacct --name="$JOB_NAME" --format=State --noheader 2>/dev/null | head -1 | tr -d ' ')

                  if [ "$JOB_STATUS" = "FAILED" ] || [ "$JOB_STATUS" = "CANCELLED" ] || [ "$JOB_STATUS" = "TIMEOUT" ]; then
                    FAILED_COUNT=$((FAILED_COUNT + 1))
                    FAILED_LIST="${FAILED_LIST}${PROBLEM_ID} (${JOB_STATUS}), "
                  else
                    PENDING_LIST="${PENDING_LIST}${PROBLEM_ID}, "
                  fi
                fi
              done

              # Remove trailing commas
              COMPLETED_LIST=$(echo "$COMPLETED_LIST" | sed 's/, $//')
              FAILED_LIST=$(echo "$FAILED_LIST" | sed 's/, $//')
              PENDING_LIST=$(echo "$PENDING_LIST" | sed 's/, $//')
              NEW_COMPLETED_LIST=$(echo "$NEW_COMPLETED_LIST" | sed 's/, $//')

              echo "  Completed: $COMPLETED_COUNT/$TOTAL_PROBLEMS ($COMPLETED_LIST)"
              echo "  Newly completed: $NEW_COMPLETED_LIST"
              echo "  Failed: $FAILED_COUNT ($FAILED_LIST)"
              echo "  Pending: ($PENDING_LIST)"

              # Check if we should process this submission
              # INCREMENTAL_NOTIFICATIONS=false: only when all done or failures with no pending
              # INCREMENTAL_NOTIFICATIONS=true: on each new completion
              SHOULD_PROCESS=false
              if [ "$INCREMENTAL_NOTIFICATIONS" = "true" ]; then
                # Incremental mode: process if any new completions
                if [ -n "$NEW_COMPLETED_LIST" ] || [ "$FAILED_COUNT" -gt 0 ]; then
                  SHOULD_PROCESS=true
                fi
              else
                # Non-incremental mode: only process when all done or all finished (with failures)
                if [ "$COMPLETED_COUNT" -ge "$TOTAL_PROBLEMS" ]; then
                  SHOULD_PROCESS=true
                elif [ "$FAILED_COUNT" -gt 0 ] && [ -z "$PENDING_LIST" ]; then
                  SHOULD_PROCESS=true
                fi
              fi

              if [ "$SHOULD_PROCESS" = "false" ]; then
                echo "  Waiting for more completions (incremental=$INCREMENTAL_NOTIFICATIONS)..."
                continue
              fi

              # Package results
              if [ "$COMPLETED_COUNT" -gt 0 ]; then
                echo "Packaging results..."
                python3 scripts/package_results.py \
                  --submission-dir "$dir" \
                  --output-dir "${PUBLIC_RESULTS}" \
                  --status-file "$STATUS_FILE" \
                  --incremental || true

                TOKEN=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('result_token', ''))" 2>/dev/null)

                if [ -n "$TOKEN" ]; then
                  echo "Results packaged with token: $TOKEN"
                  mkdir -p docs/results/${TOKEN}
                  cp -r ${PUBLIC_RESULTS}/${TOKEN}/* docs/results/${TOKEN}/
                  RESULTS_UPDATED=true
                fi
              fi

              # Send email based on mode
              if [ -n "$EMAIL" ] && [ -n "$TOKEN" ]; then
                if [ "$COMPLETED_COUNT" -ge "$TOTAL_PROBLEMS" ]; then
                  # All done - send final email
                  echo "Sending FINAL results email to: $EMAIL"
                  python3 -c "import json; f=open('$STATUS_FILE'); d=json.load(f); f.close(); d['status']='completed'; f=open('$STATUS_FILE','w'); json.dump(d,f,indent=2); f.close()"
                  printf "To: %s\nFrom: noreply@seoklab.org\nSubject: All Results Ready - KIDDS 2026\n\nHello %s,\n\nGreat news! All %s of your AlphaFold3 structure predictions are complete.\n\nCompleted: %s\n\nView your results:\n%s/viewer.html?token=%s\n\nDownload all files:\n%s/results/%s/\n\nBest regards,\nKIDDS workshop organizers\n" "$EMAIL" "$PARTICIPANT_ID" "$COMPLETED_COUNT" "$COMPLETED_LIST" "${SITE_URL}" "$TOKEN" "${SITE_URL}" "$TOKEN" | sendmail -t
                  echo "Processed submission: $SUBMISSION_ID"
                elif [ "$INCREMENTAL_NOTIFICATIONS" = "true" ] && [ -n "$NEW_COMPLETED_LIST" ]; then
                  # Incremental mode: send progress email
                  echo "Sending PROGRESS email to: $EMAIL ($COMPLETED_COUNT/$TOTAL_PROBLEMS)"
                  printf "To: %s\nFrom: noreply@seoklab.org\nSubject: Progress Update (%s/%s) - KIDDS 2026\n\nHello %s,\n\nYour AlphaFold3 predictions are in progress.\n\nCompleted: %s/%s (%s)\nJust finished: %s\nStill running: %s\n\nView your results (updates as more complete):\n%s/viewer.html?token=%s\n\nYou will receive another email when more results are ready.\n\nBest regards,\nKIDDS workshop organizers\n" "$EMAIL" "$COMPLETED_COUNT" "$TOTAL_PROBLEMS" "$PARTICIPANT_ID" "$COMPLETED_COUNT" "$TOTAL_PROBLEMS" "$COMPLETED_LIST" "$NEW_COMPLETED_LIST" "$PENDING_LIST" "${SITE_URL}" "$TOKEN" | sendmail -t
                  echo "Processed submission: $SUBMISSION_ID"
                fi
              fi

              # Handle failures (only when no more pending jobs)
              if [ "$FAILED_COUNT" -gt 0 ] && [ -z "$PENDING_LIST" ]; then
                echo "Some problems failed, sending notification..."
                python3 -c "import json; f=open('$STATUS_FILE'); d=json.load(f); f.close(); d['status']='notified_partial'; d['failed']='$FAILED_LIST'; f=open('$STATUS_FILE','w'); json.dump(d,f,indent=2); f.close()"

                if [ -n "$EMAIL" ]; then
                  if [ -n "$TOKEN" ]; then
                    printf "To: %s\nFrom: noreply@seoklab.org\nSubject: Results Ready (with errors) - KIDDS 2026\n\nHello %s,\n\nYour AlphaFold3 predictions have finished, but some encountered errors.\n\nCompleted (%s): %s\nFailed (%s): %s\n\nView your completed results:\n%s/viewer.html?token=%s\n\nThe workshop organizers have been notified. You may resubmit failed problems if needed.\n\nBest regards,\nKIDDS workshop organizers\n" "$EMAIL" "$PARTICIPANT_ID" "$COMPLETED_COUNT" "$COMPLETED_LIST" "$FAILED_COUNT" "$FAILED_LIST" "${SITE_URL}" "$TOKEN" | sendmail -t
                  else
                    printf "To: %s\nFrom: noreply@seoklab.org\nSubject: Submission Failed - KIDDS 2026\n\nHello %s,\n\nUnfortunately, your AlphaFold3 predictions encountered errors.\n\nFailed (%s): %s\n\nThe workshop organizers have been notified. You may resubmit if needed.\n\nBest regards,\nKIDDS workshop organizers\n" "$EMAIL" "$PARTICIPANT_ID" "$FAILED_COUNT" "$FAILED_LIST" | sendmail -t
                  fi
                fi

                # Send admin notification
                printf "To: %s\nFrom: noreply@seoklab.org\nSubject: [ADMIN] Submission Failure - %s\n\nSubmission ID: %s\nParticipant: %s\n\nCompleted (%s): %s\nFailed (%s): %s\n\nLogs: %s/\n" "${ADMIN_EMAIL}" "$SUBMISSION_ID" "$SUBMISSION_ID" "$PARTICIPANT_ID" "$COMPLETED_COUNT" "$COMPLETED_LIST" "$FAILED_COUNT" "$FAILED_LIST" "$dir" | sendmail -t
              fi

            else
              # Single-problem submission (backward compatibility)
              MODEL_FILE=$(find "$dir" -maxdepth 2 -name "*_model.cif" -type f 2>/dev/null | head -1)
              if [ -n "$MODEL_FILE" ]; then
                echo "Found completed output: $MODEL_FILE"
                python3 scripts/package_results.py \
                  --submission-dir "$dir" \
                  --output-dir "${PUBLIC_RESULTS}" \
                  --status-file "$STATUS_FILE"

                TOKEN=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('result_token', ''))" 2>/dev/null)

                if [ -n "$TOKEN" ]; then
                  echo "Results packaged with token: $TOKEN"
                  mkdir -p docs/results/${TOKEN}
                  cp -r ${PUBLIC_RESULTS}/${TOKEN}/* docs/results/${TOKEN}/
                  RESULTS_UPDATED=true

                  SEQ_NAME=$(python3 -c "import json; print(json.load(open('$SUBMISSION_FILE')).get('sequence_name', 'your sequence'))" 2>/dev/null)

                  if [ -n "$EMAIL" ]; then
                    printf "To: %s\nFrom: noreply@seoklab.org\nSubject: Your Protein Structure Results are Ready\n\nHello,\n\nYour AlphaFold3 structure prediction for \"%s\" is now complete!\n\nView your results:\n%s/viewer.html?token=%s\n\nDownload files:\n%s/results/%s/\n\nBest regards,\nKIDDS workshop organizers\n" "$EMAIL" "$SEQ_NAME" "${SITE_URL}" "$TOKEN" "${SITE_URL}" "$TOKEN" | sendmail -t
                  fi

                  echo "Processed submission: $SUBMISSION_ID"
                fi
              fi
            fi
          done

          echo "results_updated=$RESULTS_UPDATED" >> $GITHUB_OUTPUT

      - name: Commit and push results
        if: steps.check.outputs.results_updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/results/
          git diff --staged --quiet || git commit -m "Add completed results [skip ci]"
          git push
